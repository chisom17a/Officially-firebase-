<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Task Review</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --primary:#0d6efd;
  --success:#16a34a;
  --danger:#dc2626;
  --bg:#f4f7fa;
}
*{box-sizing:border-box;font-family:Inter,sans-serif}
body{margin:0;background:var(--bg)}
header{background:#fff;padding:15px 25px;font-weight:700;color:var(--primary)}
.container{max-width:1000px;margin:20px auto;padding:15px}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:15px}
.meta{font-size:14px;color:#444;line-height:1.6}
.actions{display:flex;gap:10px;margin-top:15px}
button{padding:10px 16px;border:none;border-radius:8px;font-weight:600;cursor:pointer}
.approve{background:var(--success);color:#fff}
.reject{background:var(--danger);color:#fff}
a{color:var(--primary)}
</style>
</head>

<body>

<header>Admin Panel – Task Approval</header>

<div class="container" id="taskContainer">Loading...</div>

<div style="text-align:center;margin-bottom:30px">
  <button onclick="location.href='adminpanel.html'">⬅ Back to Dashboard</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  doc,
  getDoc,
  updateDoc,
  deleteDoc,
  addDoc,
  increment,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCajnnfI9oxVDv4B44tiMsIgTDApt1rFjc",
  authDomain: "chiearnhub-5ba9e.firebaseapp.com",
  projectId: "chiearnhub-5ba9e",
  storageBucket: "chiearnhub-5ba9e.firebasestorage.app",
  messagingSenderId: "332513744974",
  appId: "1:332513744974:web:bfb84a79d0dbbb0057cb1f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= AUTH GUARD ================= */
const stored = JSON.parse(localStorage.getItem("currentUser"));
if (!stored) location.href = "login.html";

onAuthStateChanged(auth, async user => {
  if (!user || user.uid !== stored.uid) {
    alert("Session expired");
    location.href = "login.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if (!snap.exists() || snap.data().model !== "Admin") {
    alert("Unauthorized access");
    location.href = "login.html";
  }
});

/* ================= LOAD TASKS ================= */
const container = document.getElementById("taskContainer");

const q = query(collection(db,"tasks"), where("status","==","pending"));

onSnapshot(q, snap => {
  container.innerHTML = "";

  if (snap.empty) {
    container.innerHTML = "<p>No pending tasks.</p>";
    return;
  }

  snap.forEach(d => {
    const t = d.data();
    const id = d.id;

    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <h3>${t.platform} - ${t.type}</h3>
      <div class="meta">
        <b>User ID:</b> ${t.userId}<br>
        <b>Price per person:</b> ₦${t.price}<br>
        <b>Quantity:</b> ${t.quantity}<br>
        <b>Total:</b> ₦${t.total}<br>
        <b>Proof Title:</b> ${t.proofTitle}<br>
        <b>Link:</b> <a href="${t.link}" target="_blank">${t.link}</a>
      </div>

      <div class="actions">
        <button class="approve" onclick="approveTask('${id}')">Approve</button>
        <button class="reject" onclick="rejectTask('${id}')">Reject</button>
      </div>
    `;

    container.appendChild(div);
  });
});

/* ================= APPROVE ================= */
window.approveTask = async (id) => {
  if (!confirm("Approve this task?")) return;

  const ref = doc(db,"tasks",id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const t = snap.data();

  await addDoc(collection(db,"liveTasks"),{
    ...t,
    taskId: id,
    remaining: t.quantity,
    status: "live",
    approvedAt: serverTimestamp()
  });

  await updateDoc(ref,{ status: "approved" });

  alert("✅ Task approved and published!");
};

/* ================= REJECT ================= */
window.rejectTask = async (id) => {
  const reason = prompt("Reason for rejection?");
  if (!reason) return;

  const ref = doc(db,"tasks",id);
  const snap = await getDoc(ref);
  if (!snap.exists()) return;

  const t = snap.data();

  // Refund advertiser
  await updateDoc(doc(db,"users",t.userId),{
    balance: increment(t.total)
  });

  // Delete task
  await deleteDoc(ref);

  alert("❌ Task rejected and advertiser refunded");
};
</script>

</body>
</html>
