<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin - Verify Tasks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;background:#f4f7fa;font-family:Inter}
header{background:#fff;padding:15px 20px;font-weight:700;color:#0d6efd}
.container{max-width:1000px;margin:20px auto;padding:15px}
.card{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 2px 8px rgba(0,0,0,.05)
}
.meta{font-size:14px;color:#555;line-height:1.6}
.actions{display:flex;gap:10px;margin-top:10px}
button{
  padding:10px 16px;
  border:none;
  border-radius:8px;
  font-weight:600;
  cursor:pointer
}
.approve{background:#16a34a;color:#fff}
.reject{background:#dc2626;color:#fff}
</style>
</head>

<body>

<header>Admin ‚Äì Task Approval</header>
<div class="container" id="taskContainer">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, collection, query, where, onSnapshot,
  doc, getDoc, updateDoc, deleteDoc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCajnnfI9oxVDv4B44tiMsIgTDApt1rFjc",
  authDomain: "chiearnhub-5ba9e.firebaseapp.com",
  projectId: "chiearnhub-5ba9e",
  storageBucket: "chiearnhub-5ba9e.firebasestorage.app",
  messagingSenderId: "332513744974",
  appId: "1:332513744974:web:bfb84a79d0dbbb0057cb1f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("taskContainer");

/* ===== AUTH CHECK ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user) return location.href="login.html";

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().model !== "Admin"){
    alert("Unauthorized");
    return location.href="login.html";
  }

  loadTasks();
});

/* ===== LOAD PENDING TASKS ===== */
function loadTasks(){
  const q = query(collection(db,"tasks"), where("status","==","pending"));

  onSnapshot(q, (snap)=>{
    container.innerHTML = "";

    if(snap.empty){
      container.innerHTML = "<p>No pending tasks.</p>";
      return;
    }

    snap.forEach(docSnap=>{
      const t = docSnap.data();
      const id = docSnap.id;

      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3>${t.platform} ‚Äì ${t.type}</h3>
        <div class="meta">
          <b>Poster UID:</b> ${t.userId}<br>
          <b>Price per person:</b> ‚Ç¶${t.price}<br>
          <b>People:</b> ${t.quantity}<br>
          <b>Total:</b> ‚Ç¶${t.total}<br>
          <b>Remaining:</b> ${t.remaining}<br>
          <b>Proof:</b> ${t.proofTitle}<br>
          <b>Link:</b> <a href="${t.link}" target="_blank">${t.link}</a>
        </div>
        <div class="actions">
          <button class="approve">Approve</button>
          <button class="reject">Reject</button>
        </div>
      `;

      div.querySelector(".approve").onclick = ()=>approveTask(id, t);
      div.querySelector(".reject").onclick = ()=>rejectTask(id, t);

      container.appendChild(div);
    });
  });
}

/* ===== APPROVE TASK ===== */
async function approveTask(taskId, task){
  if(!confirm("Approve this task?")) return;

  // 1Ô∏è‚É£ Create in availabletasks
  await addDoc(collection(db,"availabletasks"),{
    taskId: taskId,
    posterId: task.userId,
    platform: task.platform,
    type: task.type,
    link: task.link,
    proofTitle: task.proofTitle,
    price: task.price,
    total: task.total,
    quantity: task.quantity,
    remaining: task.remaining,
    createdAt: serverTimestamp()
  });

  // 2Ô∏è‚É£ Update original task
  await updateDoc(doc(db,"tasks",taskId),{
    status:"approved",
    approvedAt: serverTimestamp()
  });

  alert("‚úÖ Task approved and published");
}

/* ===== REJECT TASK ===== */
async function rejectTask(taskId, task){
  const reason = prompt("Reason for rejection?");
  if(!reason) return;

  // 1Ô∏è‚É£ Refund advertiser
  const userRef = doc(db,"users",task.userId);
  const userSnap = await getDoc(userRef);
  if(userSnap.exists()){
    const bal = userSnap.data().balance || 0;
    await updateDoc(userRef,{
      balance: bal + task.total
    });
  }

  // 2Ô∏è‚É£ Update task
  await updateDoc(doc(db,"tasks",taskId),{
    status:"rejected",
    rejectionReason: reason,
    rejectedAt: serverTimestamp()
  });

  alert("‚ùå Task rejected and refunded");
}
</script>

</body>
</html>
