<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Balance Manager - Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --primary:#2563eb;
  --danger:#dc2626;
  --success:#16a34a;
  --bg:#f4f7fa;
  --white:#fff;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg)}

header{
  background:var(--white);
  padding:15px 25px;
  font-size:22px;
  font-weight:700;
  color:var(--primary);
  box-shadow:0 2px 8px rgba(0,0,0,.1);
}

.container{
  max-width:500px;
  margin:50px auto;
  background:var(--white);
  padding:25px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}

label{font-weight:600;display:block;margin-top:15px}

input,select{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}

button{
  width:100%;
  padding:14px;
  margin-top:20px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  font-weight:600;
  font-size:16px;
  cursor:pointer;
}

.secondary{background:#475569}
button:hover{opacity:.9}

.message{
  margin-top:15px;
  font-weight:600;
  text-align:center;
}
.success{color:var(--success)}
.error{color:var(--danger)}
</style>
</head>

<body>

<header>Admin – User Balance Control</header>

<div class="container">
  <label>User Email</label>
  <input type="email" id="email" placeholder="Enter user email">

  <label>Action</label>
  <select id="action">
    <option value="">Select Action</option>
    <option value="increase">Increase Balance</option>
    <option value="decrease">Decrease Balance</option>
  </select>

  <label>Amount (₦)</label>
  <input type="number" id="amount" min="1" placeholder="Enter amount">

  <button id="processBtn">Proceed</button>
  <button class="secondary" onclick="location.href='adminpanel.html'">Home</button>

  <div id="msg" class="message"></div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  updateDoc,
  increment
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* ===== FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCajnnfI9oxVDv4B44tiMsIgTDApt1rFjc",
  authDomain: "chiearnhub-5ba9e.firebaseapp.com",
  projectId: "chiearnhub-5ba9e",
  storageBucket: "chiearnhub-5ba9e.firebasestorage.app",
  messagingSenderId: "332513744974",
  appId: "1:332513744974:web:bfb84a79d0dbbb0057cb1f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== ADMIN AUTH CHECK (SAME AS adminpanel.html) ===== */
const storedUser = JSON.parse(localStorage.getItem("currentUser"));

if (!storedUser) {
  location.href = "login.html";
}

onAuthStateChanged(auth, async user => {
  if (!user || user.uid !== storedUser.uid) {
    location.href = "login.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists() || snap.data().model !== "Admin") {
    alert("Unauthorized access");
    location.href = "login.html";
  }
});

/* ===== PROCESS BALANCE ===== */
const msg = document.getElementById("msg");
document.getElementById("processBtn").onclick = async () => {
  msg.textContent = "";
  msg.className = "message";

  const email = document.getElementById("email").value.trim().toLowerCase();
  const action = document.getElementById("action").value;
  const amount = Number(document.getElementById("amount").value);

  if (!email || !action || amount <= 0) {
    msg.textContent = "Please fill all fields correctly.";
    msg.classList.add("error");
    return;
  }

  try {
    const q = query(
      collection(db, "users"),
      where("email", "==", email)
    );

    const snap = await getDocs(q);

    if (snap.empty) {
      msg.textContent = "User not found.";
      msg.classList.add("error");
      return;
    }

    const userDoc = snap.docs[0];
    const userData = userDoc.data();
    const userRef = doc(db, "users", userDoc.id);

    const currentBalance = userData.balance || 0;

    if (action === "decrease" && currentBalance < amount) {
      msg.textContent = `Insufficient balance. User has ₦${currentBalance}`;
      msg.classList.add("error");
      return;
    }

    await updateDoc(userRef, {
      balance: increment(action === "increase" ? amount : -amount)
    });

    msg.textContent = `Balance updated successfully.`;
    msg.classList.add("success");

    document.getElementById("amount").value = "";

  } catch (err) {
    msg.textContent = "Error updating balance.";
    msg.classList.add("error");
    console.error(err);
  }
};
</script>

</body>
</html>
