<!DOCTYPE html>    
<html lang="en">    
<head>    
  <meta charset="UTF-8" />    
  <title>Chiearn Hub â€“ Sign Up</title>    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />    
    
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">    
    
  <style>    
    body {    
      font-family: Poppins, sans-serif;    
      background: linear-gradient(135deg, #e8f0ff, #ffffff);    
      margin: 0;    
    }    
    .signup-section {    
      max-width: 440px;    
      margin: 80px auto;    
      background: #fff;    
      padding: 40px;    
      border-radius: 18px;    
      box-shadow: 0 6px 25px rgba(0,0,0,0.1);    
    }    
    input, select, button {    
      width: 100%;    
      padding: 13px;    
      margin: 10px 0;    
      border-radius: 8px;    
      border: 1px solid #ccc;    
    }    
    button {    
      background: #60a5fa;    
      border: none;    
      cursor: pointer;    
      font-weight: 600;  
      color: #fff;  
    }    

    .loader {
      display: none;
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #60a5fa;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>    
</head>    
    
<body>    
    
<section class="signup-section">    
  <h2>Create Account</h2>    
    
  <form id="signupForm">    
    <input id="username" placeholder="Username" required />    
    <input id="email" type="email" placeholder="Email" required />    
    <input id="phone" placeholder="Phone" required />    
    <input id="referral" placeholder="Referral (optional)" />    
    <input id="password" type="password" placeholder="Password" required />    
    <input id="repeatPassword" type="password" placeholder="Repeat Password" required />    
    
    <select id="model" required>    
      <option value="">Select role</option>    
      <option value="Earner">Earner</option>    
      <option value="Advertiser">Advertiser</option>   
    </select>    
    
    <button id="signupBtn" type="submit">Sign Up</button>    

    <div class="loader" id="loader">
      <div class="spinner"></div>
      Creating account, please wait...
    </div>

    <a href="login.html">Already have an account</a><br>
    <a href="index.html">Learn more</a>  
  </form>    
</section>    

<!-- Auto referral reader -->
<script>  
  const params = new URLSearchParams(window.location.search);  
  const ref = params.get("ref");  
  if (ref) {  
    const refInput = document.getElementById("referral");  
    refInput.value = ref.toLowerCase();  
    refInput.readOnly = true;  
  }  
</script>  
    
<script type="module">    
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";    
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";    
  import { 
    getFirestore, doc, setDoc, serverTimestamp, collection, query, where, getDocs, runTransaction 
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";    
    
  const firebaseConfig = {    
    apiKey: "AIzaSyCajnnfI9oxVDv4B44tiMsIgTDApt1rFjc",    
    authDomain: "chiearnhub-5ba9e.firebaseapp.com",    
    projectId: "chiearnhub-5ba9e",    
    storageBucket: "chiearnhub-5ba9e.firebasestorage.app",    
    messagingSenderId: "332513744974",    
    appId: "1:332513744974:web:bfb84a79d0dbbb0057cb1f"    
  };    
    
  const app = initializeApp(firebaseConfig);    
  const auth = getAuth(app);    
  const db = getFirestore(app);    

  const form = document.getElementById("signupForm");
  const btn = document.getElementById("signupBtn");
  const loader = document.getElementById("loader");

  function showLoading(){
    btn.style.display = "none";
    loader.style.display = "block";
  }

  function hideLoading(){
    btn.style.display = "block";
    loader.style.display = "none";
  }

  async function existsInUsers(field, value){
    const q = query(collection(db, "users"), where(field, "==", value));
    const snap = await getDocs(q);
    return !snap.empty;
  }

  form.addEventListener("submit", async (e) => {    
    e.preventDefault();    

    const username = document.getElementById("username").value.trim().toLowerCase();    
    const email = document.getElementById("email").value.trim().toLowerCase();    
    const phone = document.getElementById("phone").value.trim();    
    const referral = document.getElementById("referral").value.trim().toLowerCase();    
    const password = document.getElementById("password").value;    
    const repeatPassword = document.getElementById("repeatPassword").value;    
    const model = document.getElementById("model").value;    

    if(password !== repeatPassword){
      alert("Passwords do not match");
      return;
    }

    showLoading();

    try {
      // Check duplicates
      if(await existsInUsers("username", username)){
        throw "Username already taken";
      }

      if(await existsInUsers("email", email)){
        throw "Email already used";
      }

      if(await existsInUsers("phone", phone)){
        throw "Phone number already used";
      }

      let refUserDoc = null;

      if(referral){
        const q = query(collection(db, "users"), where("username", "==", referral));
        const snap = await getDocs(q);
        if(snap.empty){
          throw "Invalid referral username";
        }
        refUserDoc = snap.docs[0];
      }

      // Create auth
      const cred = await createUserWithEmailAndPassword(auth, email, password);

      // Transaction: increment referral count + create user
      await runTransaction(db, async (transaction) => {

        if(refUserDoc){
          const refRef = doc(db, "users", refUserDoc.id);
          const refSnap = await transaction.get(refRef);
          const current = refSnap.data().referralCount || 0;
          transaction.update(refRef, { referralCount: current + 1 });
        }

        const newUserRef = doc(db, "users", cred.user.uid);
        transaction.set(newUserRef, {
          username,
          email,
          phone,
          model,
          referredBy: referral || null,
          balance: 0,
          status: "pending",
          referralCount: 0,
          createdAt: serverTimestamp()
        });
      });

      alert("Account created successfully!");
      window.location.href = "login.html";

    } catch(err){
      console.error(err);
      alert(typeof err === "string" ? err : err.message);
      hideLoading();
    }
  });    
</script>    
    
</body>    
</html>
