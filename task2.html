<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chiearn Hub - Tasks</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --primary:#0d6efd;
  --bg:#f4f7fa;
  --white:#fff;
}
*{box-sizing:border-box;font-family:Inter}
body{margin:0;background:var(--bg)}
header{background:#fff;padding:15px;font-weight:600}
.container{max-width:900px;margin:auto;padding:25px}
.task-row{
  display:grid;
  grid-template-columns:1fr 120px 120px;
  gap:10px;
  background:#fff;
  padding:15px;
  margin-bottom:10px;
  border-radius:10px;
  align-items:center;
}
.perform-btn{
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:6px;
  padding:8px;
  cursor:pointer;
}
.perform-btn:disabled{
  background:#94a3b8;
}
</style>
</head>

<body>

<header>Chiearn Hub</header>

<button onclick="location.href='earner.html'">Back to Home</button>

<div class="container">
  <h2>Available Tasks</h2>
  <div id="taskList">Loading...</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore, collection, query, where, onSnapshot, getDoc, doc
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCajnnfI9oxVDv4B44tiMsIgTDApt1rFjc",
  authDomain: "chiearnhub-5ba9e.firebaseapp.com",
  projectId: "chiearnhub-5ba9e",
  storageBucket: "chiearnhub-5ba9e.firebasestorage.app",
  messagingSenderId: "332513744974",
  appId: "1:332513744974:web:bfb84a79d0dbbb0057cb1f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const list = document.getElementById("taskList");

let currentUser;
let userData = {};
let completedTasks = new Set();

/* ================= AUTH ================= */
onAuthStateChanged(auth, async (user)=>{
  if(!user) return location.href="login.html";

  currentUser = user;

  const userSnap = await getDoc(doc(db,"users",user.uid));

  if(!userSnap.exists()){
    alert("Account not found");
    return location.href="login.html";
  }

  userData = userSnap.data();

  // ‚úÖ Only earners
  if(userData.model !== "Earner"){
    alert("Access denied");
    return location.href="login.html";
  }

  // ‚úÖ Must be activated
  if(userData.status !== "active"){
    alert("Your account is not activated yet");
    return location.href="earner.html";
  }

  loadMySubmissions();
});

/* ================= LOAD SUBMISSIONS ================= */
function loadMySubmissions(){
  const q = query(
    collection(db,"submissions"),
    where("userId","==",currentUser.uid)
  );

  onSnapshot(q, snap=>{
    completedTasks.clear();

    snap.forEach(docSnap=>{
      const s = docSnap.data();

      // ‚ùó Only block if NOT rejected
      if(s.status !== "rejected"){
        completedTasks.add(s.taskId);
      }
    });

    loadTasks();
  });
}

/* ================= LOAD TASKS ================= */
function loadTasks(){
  const q = query(
    collection(db,"availabletasks"),
    where("status","==","active")
  );

  onSnapshot(q, snap=>{
    list.innerHTML = "";

    if(snap.empty){
      list.innerHTML = "<p>No tasks available at the moment.</p>";
      return;
    }

    let shown = 0;

    snap.forEach(docSnap=>{
      const t = docSnap.data();
      const id = docSnap.id;

      const remaining = t.remaining ?? 0;
      const price = t.earnerPrice ?? t.price ?? 0; // fallback to price if earnerPrice missing

      // ‚ùå No remaining slots
      if(remaining <= 0) return;

      // ‚ùå Already done by this user
      if(completedTasks.has(id)) return;

      shown++;

      const row = document.createElement("div");
      row.className = "task-row";
      row.innerHTML = `
        <div>
          <b>${t.platform}</b> - ${t.type}<br>
          <small>${t.proofTitle || ""}</small>
        </div>
        <div>‚Ç¶${price}</div>
        <button class="perform-btn">Perform</button>
      `;

      row.querySelector("button").onclick = ()=>{
        location.href = "task.html?id=" + id;
      };

      list.appendChild(row);
    });

    if(shown === 0){
      list.innerHTML = "<p>No tasks available for you right now.</p>";
    }
  });
}
</script>

</body>
  </html>
